<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps Integration</title>
    <style>
        * {
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Arial', sans-serif;
        }
        #map {
            height: 100%;
            width: 100%;
            position: relative;
        }
        .controls {
            display: flex;
            flex-direction: column;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0px 0px 30px rgba(0, 0, 0, 0.2);
            width: 350px;
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1;
        }
        h1 {
            margin: 0 0 15px;
            font-size: 24px;
            color: #007BFF;
            text-align: center;
        }
        input {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #007BFF;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input:focus {
            border-color: #0056b3;
            outline: none;
        }
        button {
            padding: 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #routeInfo {
            margin-top: 10px;
            font-size: 14px;
            color: #333;
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
        }
        #routeInfo div {
            margin: 2px 0;
        }
        .nearby {
            margin-top: 20px;
            border-top: 1px solid #ccc;
            padding-top: 10px;
            max-height: 150px; /* Set a maximum height for the nearby section */
            overflow-y: auto; /* Enable vertical scrolling */
        }
        .nearby h3 {
            margin: 0;
            font-size: 16px;
            color: #007BFF;
        }
        .nearby ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .nearby li {
            margin-bottom: 5px;
            padding: 8px;
            background-color: #e9ecef;
            border-radius: 5px;
            transition: background-color 0.3s;
            cursor: pointer; /* Change cursor to pointer for clickable items */
        }
        .nearby li:hover {
            background-color: #d1d1d1;
        }
        #toggleMenu {
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            margin-bottom: 10px;
        }
        @media (max-width: 600px) {
            .controls {
                width: calc(100% - 40px);
                top: 10px;
                left: 10px;
            }
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDfTc5T0evpoUvZrFYM0DETGibUL64zDu4&libraries=places"></script>
</head>
<body>
    <div class="controls">
        <div id="toggleMenu">Controls <span id="toggleIcon">▼</span></div>
        <div id="controlContent">
            <input id="start" type="text" placeholder="Starting Address" />
            <input id="end" type="text" placeholder="Destination Address" />
            <button id="findRoute">Find Route</button>
            <button id="cancelRoute">Cancel Route</button>
            <div id="routeInfo"></div>
            <div class="nearby">
                <h3>Nearby Landmarks:</h3>
                <ul id="landmarkList"></ul>
            </div>
        </div>
    </div>
    <div id="map"></div>
    <div id="scale"></div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let geocoder;
        const cachedPlaces = new Map(); // Cache for storing place results
        let isControlsVisible = true; // Track visibility of controls

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 14,
                center: { lat: 37.7749, lng: -122.4194 }, // Default center (San Francisco)
                scaleControl: true,
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                draggable: true,
                map: map,
                panel: null,
            });
            geocoder = new google.maps.Geocoder();

            const startInput = document.getElementById("start");
            const endInput = document.getElementById("end");

            const autocompleteStart = new google.maps.places.Autocomplete(startInput);
            const autocompleteEnd = new google.maps.places.Autocomplete(endInput);

            // Geolocation to center map
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    console.log("User Location (Geolocation API):", pos);
                    map.setCenter(pos);
                    new google.maps.Marker({
                        position: pos,
                        map: map,
                        title: "Your Location",
                        icon: {
                            url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                        }
                    });
                }, () => {
                    console.log("Geolocation failed. Using default location.");
                    handleLocationError(true);
                });
            } else {
                handleLocationError(false);
            }

            document.getElementById("findRoute").addEventListener("click", () => {
                const startAddress = startInput.value;
                const endAddress = endInput.value;

                // Use Geocoding API to get lat/lng for start and end addresses
                geocoder.geocode({ address: startAddress }, (results, status) => {
                    if (status === 'OK') {
                        const startLocation = results[0].geometry.location;
                        geocoder.geocode({ address: endAddress }, (results, status) => {
                            if (status === 'OK') {
                                const endLocation = results[0].geometry.location;
                                calculateAndDisplayRoute(startLocation, endLocation);
                            } else {
                                alert('Could not find the destination location. Please try again.');
                            }
                        });
                    } else {
                        alert('Could not find the starting location. Please try again.');
                    }
                });
            });

            document.getElementById("cancelRoute").addEventListener("click", () => {
                // Clear directions and reset inputs for new search
                directionsRenderer.setMap(null); // Remove the current route from the map
                directionsRenderer.setMap(map); // Reattach the directions renderer to the map
                document.getElementById("landmarkList").innerHTML = ''; // Clear landmarks
                startInput.value = '';
                endInput.value = '';
            });

            google.maps.event.addListener(directionsRenderer, 'directions_changed', () => {
                const directions = directionsRenderer.getDirections();
                if (directions) {
                    const route = directions.routes[0];
                    findNearbyLandmarks(route);
                }
            });

            // Toggle control display
            document.getElementById("toggleMenu").addEventListener("click", () => {
                const controlContent = document.getElementById("controlContent");
                controlContent.style.display = isControlsVisible ? "none" : "flex"; // Toggle visibility
                document.getElementById("toggleIcon").innerText = isControlsVisible ? "▲" : "▼"; // Change icon
                isControlsVisible = !isControlsVisible; // Update visibility state
            });

            // Dynamic scale
            google.maps.event.addListener(map, 'zoom_changed', () => {
                const zoomLevel = map.getZoom();
                document.getElementById("scale").innerText = `Zoom Level: ${zoomLevel}`;
            });
        }

        function handleLocationError(browserHasGeolocation) {
            const pos = { lat: 37.7749, lng: -122.4194 }; // Default location (San Francisco)
            map.setCenter(pos);
            alert(browserHasGeolocation ? 'Error: The Geolocation service failed.' : 'Error: Your browser doesn\'t support geolocation.');
        }

        function calculateAndDisplayRoute(start, end) {
            directionsService.route(
                {
                    origin: start,
                    destination: end,
                    travelMode: google.maps.TravelMode.DRIVING,
                },
                (response, status) => {
                    if (status === 'OK') {
                        directionsRenderer.setDirections(response);
                        findNearbyLandmarks(response.routes[0]); // Find landmarks along the route
                    } else {
                        alert('Directions request failed due to ' + status);
                    }
                }
            );
        }

        function findNearbyLandmarks(route) {
            const service = new google.maps.places.PlacesService(map);
            const bounds = new google.maps.LatLngBounds();

            // Extend the bounds to include the route path
            route.legs.forEach(leg => {
                leg.steps.forEach(step => {
                    bounds.extend(step.start_location);
                    bounds.extend(step.end_location);
                });
            });
            map.fitBounds(bounds); // Adjust map to show the route

            // Search for nearby landmarks
            const request = {
                location: bounds.getCenter(),
                radius: '500', // Define radius for the search (in meters)
                type: ['restaurant', 'gas_station'], // Search for restaurants and petrol stations
            };

            service.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    displayLandmarks(results);
                } else {
                    console.error('Places service failed due to ' + status);
                }
            });
        }

        function displayLandmarks(landmarks) {
            const landmarkList = document.getElementById("landmarkList");
            landmarkList.innerHTML = ''; // Clear previous landmarks
            landmarks.forEach(landmark => {
                const li = document.createElement("li");
                li.innerText = landmark.name;
                li.onclick = () => {
                    map.setCenter(landmark.geometry.location); // Center map on landmark
                    map.setZoom(15); // Optionally zoom in on the landmark
                };
                landmarkList.appendChild(li);
                new google.maps.Marker({
                    position: landmark.geometry.location,
                    map: map,
                    title: landmark.name,
                });
            });
        }

        window.onload = initMap; // Initialize the map when the window loads
    </script>
</body>
</html>
